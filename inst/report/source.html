<!doctype html>
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/default.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/2.3.3/css/dataTables.dataTables.css" />

    <title>{{ pkgname }} test coverage</title>

    <style>
      h2 {
        margin-top: 20px;
        margin-bottom: 10px;
      }
      a {
        color: rgb(51, 122, 183);
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }
      pre code.hljs {
        padding: 5px;
      }
      table.hljs-ln {
        width: 100%;
      }
      .hljs-ln-numbers {
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        padding-left: 5px !important;
        padding-right: 5px !important;
        text-align: right;
        color: #bbb;
        border-right: 1px solid #CCC;
      }
      .hljs-ln-coverage {
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        padding-left: 5px !important;
        padding-right: 5px !important;
        text-align: right;
        border-right: 1px solid #CCC;
      }
      .hljs-ln-nocoverage {
        background: rgba(246, 198, 206, 1);
      }
      .hljs-ln-yescoverage {
        background: rgba(230, 245, 208, 1);
      }
      .hljs-ln-nocoveragecode {
        background: rgba(203, 68, 66, 0.05);
      }
      .hljs-ln-nocoveragecode:hover {
        border-bottom: 2px solid #a30808;
      }
      .hljs-ln-yescoveragecode:hover {
        border-bottom: 2px solid #49d836;
      }
      .hljs-ln-code {
        padding-left: 5px !important;
      }
      .rule {
        height: 10px;
        margin-top: 10px;
        margin-bottom: 10px;
      }
      .rule-good {
        background: rgba(77, 146, 33, 1);
      }
      .rule-ok {
        background: rgba(0, 0, 255, 1);
      }
      .rule-bad {
        background: rgba(255, 165, 0, 1);
      }
      .rule-na {
        background: #000;
      }
      .mono {
        font-family: monospace;
      }
      .linenumber {
        color: #bbb;
      }
      table tr:hover td {
        font-weight: bold;
        text-decoration: none;
      }
      span.cov-summary-cont {
        margin-right: 30px;
      }
      code.cov-summary {
        color: black;
        background: #ddd;
        padding: 4px 5px;
        border-radius: 3px;
      }
      span.bold {
        font-weight: bold;
      }
      tr.marker, td.marker {
        background: rgba(122, 186, 196, 0.5);
      }
      tr.marker .hljs-ln-n {
        font-weight: bold;
        color:rgb(14, 23, 78)
      }
      div#col-left, div#col-right {
        max-height: 100vh;
        overflow-y: scroll;
      }
    </style>
  </head>
  <body>
    <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js" integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/r.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/c++.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/c.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.9.0/highlightjs-line-numbers.min.js"></script>
    <script src="https://cdn.datatables.net/2.3.3/js/dataTables.js"></script>
    <script>
      // this is example data, that will be overwritten
      var lines = [
        "parse_log_record_message <- function(msg) {",
        "  ccall(otel_parse_log_record, msg)",
        "}",
        "",
        "collector_app <- function() {",
        "  app <- webfakes::new_app()",
        "  app$locals$logs <- list()",
        "  app$locals$traces <- list()",
        "  app$locals$metrics <- list()",
        "  app$post(",
        "    c(\"/v1/traces\", \"/v1/metrics\", \"/v1/logs\"),",
        "    function(req, res) {",
        "      if (req$get_header(\"content-type\") != \"application/x-protobuf\") {",
        "        bd <- encode_response(",
        "          \"traces\",",
        "          \"failure\",",
        "          error_message = \"missing or wrong content-type header\"",
        "        )",
        "        res$set_status(400L)",
        "        res$send(bd)",
        "        return()",
        "      }",
        "      \"next\"",
        "    }",
        "  )",
        "  app$post(\"/v1/traces\", function(req, res) {",
        "    # TODO",
        "  })",
        "  app$post(\"/v1/metrics\", function(req, res) {",
        "    req <<- req",
        "    record <- ccall(otel_parse_metrics_record, req$.body)",
        "    app$locals$metrics <- c(app$locals$metrics, list(record))",
        "    bd <- encode_response(\"metrics\")",
        "    res$set_status(200)",
        "    res$set_type(\"application/x-protobuf\")",
        "    res$send(bd)",
        "  })"
    ];
    var coverage = [
      NaN,   0, NaN, NaN, NaN,  10,  10,  10,  10,  10,
       10,  10,   0,   0,   0,   0,   0, NaN,   0,   0,
        0, NaN,   0, NaN, NaN,   1, NaN, NaN,   1,   0,
        0,   0,   0,   0,   0,   0, NaN, NaN,   1,   0
    ];
    var funcs = [
      [ 1,  0, "parse_log_record_message" ],
      [ 5, 10, "collector_app" ],
      [ 12, 0, NaN ],
      [ 26, 0, NaN ],
      [ 29, 0, NaN ]
    ];
    </script>

    <script>
      lines = {{ lines }};
      coverage = {{ coverage }};
      funcs = {{ funcs }};
      var editorScheme = "{{ editor_scheme }}";
      var filePath = "{{ file_path_normalized }}";
    </script>

    <script>
      var code = lines.join("\n");
      
      function createEditorLink(text, line) {
        if (editorScheme && filePath) {
          var url = editorScheme + "://file" + filePath + (line ? ":" + line : "");
          return "<a href=\"" + url + "\" title=\"Open in " + editorScheme + "\">" + text + "</a>";
        }
        return text;
      }
      
      function funclick(row) {
        $('.marker').removeClass('marker');
        var td = $('#L' + row);
        td.addClass("marker");
        td.parent().addClass('marker');
        return true;
      }
      
      function lineclick(row) {
        // If we have editor scheme, try to open in editor, otherwise use funclick
        if (editorScheme && filePath) {
          var url = editorScheme + "://file" + filePath + ":" + row;
          window.open(url, '_blank');
          return false;
        } else {
          return funclick(row);
        }
      }
      $(document).ready( function() {
        // insert code
        $('#coverage').text(code);
        // syntax highlight
        hljs.highlightAll();
        // add line numbers
        $('code.hljs').each(function(i, block) {
          hljs.lineNumbersBlockSync(block, { singleLine: true });
        });
        
        // Make line numbers clickable for editor links
        if (editorScheme && filePath) {
          $('#coverage tr td.hljs-ln-numbers').each(function(i) {
            var lineNum = i + 1;
            var originalContent = $(this).text();
            $(this).html('<a href="' + editorScheme + '://file' + filePath + ':' + lineNum + '" title="Open line ' + lineNum + ' in ' + editorScheme + '" onclick="return lineclick(' + lineNum + ');">' + originalContent + '</a>');
          });
        }
        // add coverage numbers
        var tds = $('#coverage tr td.hljs-ln-numbers');
        var tls = $('#coverage tr td.hljs-ln-code');
        tds.each(function(i) {
          var m = "", cl = "", clc = "";
          if (!isNaN(coverage[i])) {
            if (coverage[i] == 0) {
              m = "!";
              cl = "hljs-ln-nocoverage";
              clc = "hljs-ln-nocoveragecode";
            } else {
              m = coverage[i] + "x"
              cl = "hljs-ln-yescoverage";
              clc = "hljs-ln-yescoveragecode";
            }
          }
          $('<td id="L' + (i+1) + '" class="hljs-ln-line hljs-ln-coverage ' + cl + '">' + m + '</td>')
            .insertAfter($(this));
          if (clc != "") {
            tls[i].className += " " + clc;
          }
        });
        function color_coverage_cb(td, cellData, rowData, row, col) {
          if (cellData > 0) {
            $(td).addClass("hljs-ln-yescoverage");
            $(td).text(cellData + 'x');
          } else {
            $(td).text("!")
            $(td).addClass("hljs-ln-nocoverage");
          }
        }
        function fun_name_cb(td, cellData, rowData, row, col) {
          if (!cellData) {
            $(td)
              .text("<anonymous>")
              .css('font-style', 'italic')
              .css('color', '#ccc');
          }
        }
        function linum_cb(td, cellData, rowData, row, col) {
          $(td).text("").append("<a href=\"#L" + cellData + "\" onClick=\"return funclick(" + cellData + ");\">" + cellData + "</a>")
        }
        if (funcs.length == 0) {
          $('#functions').hide()
        } else {
          $('#functions').DataTable({
            data: funcs,
            paging: false,
            searching: false,
            language: {
              info: "",
            },
            columnDefs: [
              { targets: [0], className: 'linenumber', createdCell: linum_cb },
              { targets: [0, 1], className: "dt-right mono" },
              { targets: [1], createdCell: color_coverage_cb },
              { targets: [2], createdCell: fun_name_cb },
              { targets: [2], className: "mono" }
            ]
          });
        }
      });
    </script>
    <div class="container">
      <div class="row">
        <div class="col-md-12">
          <h2>
            <a href="{{ pkgname }}-report.html">{{ pkgname }} test coverage</a>
          </h2>
          <h3>{{ file_header }}</h3>
          <span class="cov-summary-cont">
            <span class="bold">{{ file_percent }}</span> lines
            <code class="cov-summary">{{ file_lines_covered }}/{{ file_lines }}</code>
          </span>
          <span class="cov-summary-cont">
            <span class="bold">{{ file_funcs_percent }}</span> functions
            <code class="cov-summary">{{ file_funcs_hit }}/{{ file_funcs }}</code>
          </span>
          <div class="rule rule-{{ file_status }}"></div>
        </div>
        <div class="col-md-9" id="col-left">
          <pre><code id="coverage" class="{{ language }}">
          </code></pre>
        </div>
        <div class="col-md-3" id="col-right">
          <table id="functions" class="row-border">
            <thead>
              <th>#</th>
              <th>C</th>
              <th>Function</th>
            </thead>
          </table>
        </div>
      </div>
    </div>
  </body>
</html>
